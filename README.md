## Инструкция по запуску приложения:

1) Клонируем репозиторий:
   ```
   git clone git@github.com:stybayev/ugc_sprint_2.git
   ```
2) Заходим в корневую директрию проекта `/ugc_sprint_2`:
   ```
   cd ugc_sprint_2
   ```
3) Создаем файл `.env` и копируем в него содержимое файла `.env.example`:
   ```
   cp .env.example .env
   ```
4) Запускаем сервисы:
   ```
   docker-compose -f docker-compose.ugc.yml -f docker-compose.dev.yml  up --build 
   ```
5) Все должно работать!

***

## Сервисы приложения:

### Сервис добавления лайков, рецензий и закладок

Этот сервис предназначен для работы с пользовательскими взаимодействиями, такими как добавление лайков, написание
рецензий на фильмы и управление закладками.

С его помощью можно:

- Просматривать количество лайков и дизлайков у фильма.
- Просматривать среднюю пользовательскую оценку фильма.
- Добавлять, удалять или изменять лайк, дизлайк или оценку фильма.
- Добавлять рецензии на фильмы, которые включают текст, дату публикации, автора, и другие метаданные.
- Лайкать или дизлайкать рецензии, чтобы отметить наиболее полезные из них.
- Добавлять фильмы в закладки для последующего просмотра.
- Удалять фильмы из закладок.
- Просматривать список закладок.
- Получать список рецензий с возможностью гибкой сортировки по количеству лайков, дизлайков, рейтингу и дате публикации.

**Адрес:**

```
http://0.0.0.0:8085/api/rating/openapi
```

### Сервис UGC

Этот сервис предназначен для отслеживания взаимодействий пользователей, таких как клики, просмотры страниц и кастомные
события.

С его помощью можно:

- Отслеживать пользовательские события с JWT-аутентификацией.
- Отслеживать внутренние события, используемые между микросервисами, без необходимости JWT-аутентификации.

#### Роуты:

#### 1 External Track Event (http://127.0.0.1/api/ugc/tracking/external_track_event/)

Эндпоинт для отслеживания пользовательских событий. Предполагает использование JWT-аутентификации.

Метод: POST

#### Параметры:

- Authorization (в заголовке): JWT Token для авторизации.
- body (в теле запроса): JSON-объект с информацией о событии.
- event_type (string): Тип события (click, page_view, custom_event).
- timestamp (string): Временная метка события.
- data (object): Дополнительные данные о событии.
- source (string): Источник события.

#### Ответы:

- 200 OK: Событие успешно отслежено.
- 400 Bad Request: Неизвестный тип события.
- 503 Service Unavailable: Сервис временно недоступен (например, Kafka не отвечает).

#### 2 - Internal Track Event (http://127.0.0.1/api/ugc/tracking/internal_track_event/)

Внутренний эндпоинт для отслеживания событий между микросервисами. JWT-аутентификация не требуется.

Метод: POST

#### Параметры:

- body (в теле запроса): JSON-объект с информацией о событии.
- user_id (string): ID пользователя.
- event_type (string): Тип события (click, page_view, custom_event).
- timestamp (string): Временная метка события.
- data (object): Дополнительные данные о событии.
- source (string): Источник события.

#### Ответы:

- 200 OK: Событие успешно отслежено.
- 400 Bad Request: Неизвестный тип события.
- 503 Service Unavailable: Сервис временно недоступен (например, Kafka не отвечает).

**Адрес:**

```
http://0.0.0.0:8084/apidocs/
```

### Сервис Auth

Этот сервис предназначен для управления аутентификацией и авторизацией пользователей.

С его помощью можно:

- Регистрировать пользователей.
- Выполнять вход в аккаунт и получать пару токенов (JWT-access и refresh токены).
- Обновлять access-токен.
- Выполнять выход из аккаунта.
- Изменять логин или пароль пользователя.
- Получать историю входов пользователя.
- Управлять ролями пользователей.
- Связывать и откреплять аккаунты пользователей с аккаунтами в Яндекс (OAuth).

**Адрес:**

```
http://127.0.0.1/api/auth/openapi
```

**Добавление суперпользователя в систему:**

Для добавления суперпользователя необходимо ввести следующую команду (admin - логин пользователя, password - пароль
пользователя:

```
python auth/core/su.py admin password
```

***

### Сервис Django Admin

Этот сервис предназначен для управления контентом фильмов через административный интерфейс.

С помощью него можно:

- Загрузить фильм в базу данных.
- Редактировать информацию о фильме.
- Управлять жанрами и персонами.
- Просматривать подробную информацию о фильмах.

**Адрес:**

```
http://127.0.0.1/admin
```

***

### Cервис выдачи контента

Этот сервис предназначен для управления и предоставления информации о фильмах.

С помощью него можно:

- Получать список всех доступных фильмов.
- Получать подробную информацию о конкретном фильме.

**Адрес:**

```
http://127.0.0.1/api/films/openapi
```

***

### Cервис FileApi

Этот сервис предназначен для работы с файлами.

С его помощью можно:

- Загружать файлы на сервер.
- Скачивать файлы с сервера.

**Адрес:**

```
http://127.0.0.1/api/files/openapi
```

***

### Jaeger

Jaeger используется для трассировки запросов в микросервисной архитектуре.

**Адрес:**

```
http://127.0.0.1:16686
```

***

### ETL Kafka to Clickhouse

Сервис для записи сообщений из Kafka в Clickhouse. Необходимые настройки для сервиса находятся в файле .env:

```yml
# ==== ETL KAFKA CLICKHOUSE ====
CLICKHOUSE_PORT=8123
CLICKHOUSE_POLL_RECORDS=10  # Количество сообщений которое будет записываться в Clickhouse
KAFKA_BOOTSTRAP_SERVERS=kafka-0:9092,kafka-1:9092,kafka-2:9092  # Ноды Kafka
KAFKA_TOPICS=click-events,page-view-events,custom_event   # Топики Kafka
CONSUMER_GROUP_ID=movies  # Идентификатор группы потребителя (consumer)
```

```python
consumer = AIOKafkaConsumer(
    *topics,
    bootstrap_servers=bootstrap_servers,
    group_id='movies',
    enable_auto_commit=False,  # Отключаем авто-подтверждение смещений
    auto_offset_reset='earliest',
    max_poll_records=poll_records
)
```

Автоматическое смещение в консумере отключено, смещение происходит только после успешного сохранения данных в
Clickhouse.
Это сделано для сохранения порядка загрузки данных при потере связи с Clickhouse и последующем восстановлении.

## Инструкция по запуску тестов

1. **Переход в директорию тестов:**

   Навигация к папке с тестами.
   ```bash
   cd tests/unit

2. **Запуск тестовых сервисов:**

   Используйте docker-compose для запуска тестов.
   ```bash
   docker-compose -f docker-compose.yml up --build

3. **Остановка и очистка тестовой среды:**

   После завершения тестирования рекомендуется остановить контейнеры и очистить созданные ресурсы.

   ```bash
   docker-compose down -v
